# Nombre del workflow que aparecer치 en la pesta침a "Actions"
name: 'Generar Informe Manualmente'

on:
  workflow_dispatch:

jobs:
  generate-report-only:
    runs-on: ubuntu-latest

    # --- A칌ADIDO: Permisos para que el robot pueda hacer 'git push' ---
    permissions:
      contents: write

    steps:
      # Paso 1: Descarga una copia de tu repositorio
      - name: 1. Descargar el c칩digo del repositorio
        uses: actions/checkout@v4

      # Paso 2: Configura el entorno de Python
      - name: 2. Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Paso 3: Instala las librer칤as necesarias
      - name: 3. Instalar las librer칤as necesarias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Paso 4 (DEBUG - Opcional, pero 칰til): Verifica que el Excel es el correcto
      - name: '4. DEBUG: Verificar qu칠 archivos y commits ve el robot'
        run: |
          echo "--- 1. Mostrando el commit que se est치 usando ---"
          git log -n 1
          echo "--- 2. Listando los archivos descargados ---"
          ls -lR
          echo "--- 3. Leyendo las 칰ltimas filas del Excel con Python ---"
          python -c "import pandas as pd; df = pd.read_excel('Comentarios Campa침a.xlsx'); print('El archivo tiene', len(df), 'filas en total.'); print('--- MOSTRANDO LAS 칔LTIMAS 10 FILAS ---'); print(df.tail(10))"

      # Paso 5: Ejecuta tu script para generar el nuevo index.html
      - name: 5. Ejecutar S칍LO la generaci칩n del informe
        run: python generar_informe.py

      # ====================================================================
      # PASO DE DIAGN칍STICO A칌ADIDO: Revisa la salida de este paso en "Actions"
      # ====================================================================
      - name: '6. DEBUG: Verificar si Git detecta cambios'
        run: |
          echo "--- Revisando el estado con 'git status' ---"
          git status
          echo "--- Mostrando las diferencias exactas en index.html ---"
          git diff index.html

      # Paso 7: Sube el nuevo index.html al repositorio
      - name: 7. Subir los archivos actualizados al repositorio
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add index.html
          # Revisa si hay cambios para "commitear", y si los hay, los sube.
          git diff-index --quiet HEAD || git commit -m "游늵 Actualizaci칩n manual del informe"
          git push
